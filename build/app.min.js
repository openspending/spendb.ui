/*! spendb.ui v0.19.0 */function longestCommonStart(a){for(var b=a.concat().sort(),c=b[0],d=b[b.length-1],e=c.length,f=0;e>f&&c.charAt(f)===d.charAt(f);)f++;return c.substring(0,f)}function cleanLabel(a){for(var b=" ",c=a.replace(/[\W_]/g,b).split(b),d=0;d<c.length;d++){var e=c[d].charAt(0).toUpperCase();c[d]=e+c[d].substr(1)}return c.join(b).replace(/\s+/g,b).trim()}angular.module("spendb.templates",["account/login.html","account/profile.html","account/reset.html","account/settings.html","dataset/about.html","dataset/delete.html","dataset/dimension_edit.html","dataset/dimensions.html","dataset/edit.html","dataset/hierarchies.html","dataset/measures.html","dataset/new.html","dataset/query.html","dataset/sources.html","dataset/upload.html","directives/dataset_list.html","directives/dataset_settings.html","directives/page_body.html","directives/page_header.html","directives/response_pager.html","docs.html","home.html"]),angular.module("account/login.html",[]).run(["$templateCache",function(a){a.put("account/login.html",'<page-header></page-header><page-body><div class="row"><div class="col-md-6"><h3 class="page-header">Login</h3><form class="form-horizontal" name="loginForm" ng-submit="login(loginForm)"><div class="form-group" ng-class="{\'has-error\': loginForm.login.$invalid}"><label for="login" class="col-sm-3 control-label">Login</label><div class="col-sm-9"><input name="login" class="form-control" ng-model="credentials.login"></div></div><div class="form-group" ng-class="{\'has-error\': loginForm.password.$invalid}"><label for="password" class="col-sm-3 control-label">Password</label><div class="col-sm-9"><input name="password" class="form-control" type="password" ng-model="credentials.password"><p class="help-block" ng-show="loginForm.password.$invalid" ng-bind="loginForm.password.$message"></p><p class="help-block">Forgot your password? <a class="ng-link" ng-click="resetPassword()">Request a password reset.</a></p></div></div><div class="form-group"><div class="col-sm-offset-3 col-sm-9"><button type="submit" class="btn btn-default">Login</button></div></div></form></div><div class="col-md-6"><h3 class="page-header">Create an account</h3><form class="form-horizontal" name="regForm" ng-submit="register(regForm)"><div class="form-group" ng-class="{\'has-error\': regForm.name.$invalid}"><label for="name" class="col-sm-3 control-label">Login</label><div class="col-sm-9"><input name="name" class="form-control" ng-model="account.name"><p class="help-block" ng-show="regForm.name.$invalid" ng-bind="regForm.name.$message"></p></div></div><div class="form-group" ng-class="{\'has-error\': regForm.fullname.$invalid}"><label for="fullname" class="col-sm-3 control-label">Fullname</label><div class="col-sm-9"><input name="fullname" class="form-control" ng-model="account.fullname"><p class="help-block" ng-show="regForm.fullname.$invalid" ng-bind="regForm.fullname.$message"></p></div></div><div class="form-group" ng-class="{\'has-error\': regForm.email.$invalid}"><label for="email" class="col-sm-3 control-label">Email</label><div class="col-sm-9"><input name="email" class="form-control" type="email" ng-model="account.email"><p class="help-block" ng-show="regForm.email.$invalid" ng-bind="regForm.email.$message"></p></div></div><div class="form-group" ng-class="{\'has-error\': regForm.password1.$invalid}"><label for="password1" class="col-sm-3 control-label">Password</label><div class="col-sm-9"><input name="password1" class="form-control" type="password" ng-model="account.password1" autocomplete="off"><p class="help-block" ng-show="regForm.password1.$invalid" ng-bind="regForm.password1.$message"></p></div></div><div class="form-group" ng-class="{\'has-error\': regForm.password2.$invalid}"><label for="password2" class="col-sm-3 control-label">Password (repeat)</label><div class="col-sm-9"><input name="password2" class="form-control" type="password" ng-model="account.password2" autocomplete="off"><p class="help-block" ng-show="regForm.password2.$invalid" ng-bind="regForm.password2.$message"></p></div></div><div class="form-group" ng-class="{\'has-error\': regForm.terms.$invalid}"><div class="col-sm-offset-3 col-sm-9"><div class="checkbox"><label><input name="terms" type="checkbox" ng-model="account.terms"> I agree to the Terms of Use and Privacy Policy (<a href="/docs/tos.html">read more</a>).</label></div></div></div><div class="form-group"><div class="col-sm-offset-3 col-sm-9"><button type="submit" class="btn btn-default">Create new account</button></div></div></form></div></div></page-body>')}]),angular.module("account/profile.html",[]).run(["$templateCache",function(a){a.put("account/profile.html",'<page-header></page-header><page-body><div class="row"><div class="col-md-3"><img ng-src="{{account.gravatar}}?s=200" alt="Gravatar for {{account.display_name}}"></div><div class="col-md-9"><h3>Information<div class="pull-right" ng-show="own_profile"><a class="btn btn-sm btn-success" href="/settings">Settings</a></div></h3><table class="table table-condensed"><tr ng-if="account.fullname"><th>Name</th><td>{{account.fullname}}</td></tr><tr><th>Username</th><td>{{account.name}}</td></tr><tr ng-if="account.email"><th>Email</th><td>{{account.email}}</td></tr><tr ng-if="account.twitter_handle"><th>Twitter</th><td><a href="https://twitter.com/{{ account.twitter_handle }}">@{{ account.twitter_handle }}</a></td></tr></table></div></div><div class="row"><div class="col-md-offset-3 col-md-9"><h3>Datasets<div class="pull-right" ng-show="own_profile"><a class="btn btn-sm btn-success" href="/datasets/new">Import a dataset</a></div></h3><dataset-list datasets="datasets"></dataset-list><p ng-show="own_profile && datasets.total == 0">It looks like you haven\'t uploaded any datasets.</p></div></div></page-body>')}]),angular.module("account/reset.html",[]).run(["$templateCache",function(a){a.put("account/reset.html",'<div class="modal-header"><button type="button" class="close" ng-click="close()" aria-hidden="true">&times;</button><h4 class="modal-title">Reset your account password</h4></div><form class="form-horizontal"><div class="modal-body"><p>If you have forgotten the password for your account, you can request an email with a link that will allow you to reset your account password.</p><div class="alert alert-success" ng-show="res.status == \'ok\'">{{res.message}}</div><div class="form-group" ng-hide="sent" ng-class="{\'has-error\': res.status == \'error\'}"><label for="email" class="col-sm-3 control-label">Email</label><div class="col-sm-9"><input name="email" class="form-control" type="email" ng-model="data.email"><p class="help-block" ng-show="res.status == \'error\'" ng-bind="res.message"></p></div></div></div><div class="modal-footer" ng-hide="sent"><button type="button" class="btn btn-default" ng-click="close()">Cancel</button> <button type="button" class="btn btn-success" ng-click="send()">Send reset email</button></div><div class="modal-footer" ng-show="sent"><button type="button" class="btn btn-default" ng-click="close()">OK</button></div></form>')}]),angular.module("account/settings.html",[]).run(["$templateCache",function(a){a.put("account/settings.html",'<page-header></page-header><page-body><div class="row"><div class="col-sm-offset-2 col-sm-10"><form class="form-horizontal" name="form" ng-submit="save(form)"><div class="form-group" ng-class="{\'has-error\': form.fullname.$invalid}"><label for="fullname" class="col-sm-2 control-label">Full name</label><div class="col-sm-10"><input name="fullname" class="form-control" ng-model="account.fullname"><p class="help-block" ng-show="form.fullname.$invalid" ng-bind="form.fullname.$message"></p></div></div><div class="form-group" ng-class="{\'has-error\': form.email.$invalid}"><label for="email" class="col-sm-2 control-label">Email</label><div class="col-sm-7"><input name="email" class="form-control" ng-model="account.email" placeholder="you@domain.com"><p class="help-block" ng-show="form.email.$invalid" ng-bind="form.email.$message"></p></div><div class="col-sm-3"><div class="checkbox"><label><input name="public_email" type="checkbox" ng-model="account.public_email"> Visible to others</label></div></div></div><div class="form-group" ng-class="{\'has-error\': form.twitter_handle.$invalid}"><label for="twitter" class="col-sm-2 control-label">Twitter</label><div class="col-sm-7"><input name="twitter" class="form-control" ng-model="account.twitter_handle" placeholder="@mapthemoney"><p class="help-block" ng-show="form.twitter_handle.$invalid" ng-bind="form.twitter_handle.$message"></p></div><div class="col-sm-3"><div class="checkbox"><label><input name="public_twitter" type="checkbox" ng-model="account.public_twitter"> Visible to others</label></div></div></div><div class="form-group" ng-class="{\'has-error\': form.password1.$invalid}"><label for="password1" class="col-sm-2 control-label">Password</label><div class="col-sm-10"><input name="password1" type="password" autocomplete="off" ng-model="account.password1" class="form-control"><p class="help-block" ng-show="form.password1.$invalid" ng-bind="form.password1.$message"></p></div></div><div class="form-group" ng-class="{\'has-error\': form.password2.$invalid}"><label for="password2" class="col-sm-2 control-label">Password (repeat)</label><div class="col-sm-10"><input name="password2" type="password" autocomplete="off" ng-model="account.password2" class="form-control"><p class="help-block">Leave both fields blank to keep your current password.</p><p class="help-block" ng-show="form.password2.$invalid" ng-bind="form.password2.$message"></p></div></div><div class="form-group"><label for="api_key" class="col-sm-2 control-label">API Key</label><div class="col-sm-10"><input class="form-control" name="api_key" ng-model="session.api_key" readonly="readonly"><p class="help-block">Use this key to access the API programmatically.</p></div></div><div class="form-group"><div class="col-sm-offset-2 col-sm-10"><button type="submit" class="btn btn-default">Save</button></div></div></form></div></div></page-body>')}]),angular.module("dataset/about.html",[]).run(["$templateCache",function(a){a.put("dataset/about.html",'<page-header dataset="dataset" section="about"></page-header><page-body><div class="row"><div class="col-md-8"><h4 class="page-header"><div class="pull-right" ng-show="dataset.can_update"><small><a ng-href="/datasets/{{dataset.name}}/edit">change</a></small></div>About {{dataset.label}}</h4><blockquote ng-show="dataset.description"><p>{{ dataset.description }}</p></blockquote><table class="table"><tr><th>Contributors</th><td><span ng-repeat="manager in managers.managers"><a href="/accounts/{{manager.name}}"><img class="gravatar" ng-src="{{ manager.gravatar }}?s=22" width="22" height="22" alt="{{ manager.display_name }}"> {{manager.display_name}}</a> <span ng-hide="$last">&middot;</span></span></td></tr><tr><th width="30%">Category</th><td>{{ getReferenceLabel(\'categories\', dataset.category) }}</td></tr><tr><th>Countries</th><td><span ng-repeat="territory in dataset.territories"><a href="/?territories={{territory}}">{{ getReferenceLabel(\'territories\', territory) }}</a> <span ng-hide="$last">&middot;</span></span></td></tr><tr ng-show="dataset.has_model"><th>Dimensions <small ng-show="dataset.can_update"><a ng-href="/datasets/{{dataset.name}}/model/dimensions">change</a></small></th><td><span ng-repeat="(name, dim) in model.dimensions"><a ng-href="/datasets/{{dataset.name}}?view=crosstab&rows={{name}}.{{dim.label_attribute}}">{{ dim.label }}</a> <small>({{ dim.cardinality }})</small> <span ng-hide="$last">&middot;</span></span></td></tr><tr ng-show="dataset.has_model"><th>Measures <small ng-show="dataset.can_update"><a ng-href="/datasets/{{dataset.name}}/model/measures">change</a></small></th><td><span ng-repeat="(name, meas) in model.measures">{{ meas.label }} <span ng-hide="$last">&middot;</span></span> <small>in {{ getReferenceLabel(\'currencies\', dataset.currency) }} ({{dataset.currency}})</small></td></tr><tr><th>Created</th><td>{{ dataset.created_at | formatDate }}</td></tr></table><div ng-show="sources.results"><h4 class="page-header"><div class="pull-right" ng-show="dataset.can_update"><small><a ng-href="/datasets/{{dataset.name}}/sources">add</a></small></div>Source data</h4><p class="help-block">Source files are the origin of the data presented here. They are preserved and available for download.</p><table class="table"><tr><th></th><th>Uploaded</th><th>Archive</th></tr><tr ng-repeat="source in sources.results"><th>{{source.name}} <a ng-show="source.source_url" ng-href="{{ source.source_url}}" class="btn btn-default btn-xs" target="_self">url</a></th><td>{{ source.created_at | formatDate }}</td><td><a ng-href="{{ source.data_url}}" class="btn btn-default btn-xs" target="_self"><span ng-show="source.mime_type && source.mime_type.length > 1 && source.mime_type.length < 20">{{source.mime_type}}</span> <span ng-hide="source.mime_type && source.mime_type.length > 1 && source.mime_type.length < 20">download</span></a></td></tr></table></div></div><div class="col-md-4"><div ng-show="dataset.has_model"><h4 class="page-header">API</h4><p class="help-block">Datasets support visualisations and analysis through an API, the developer interface. {{config.site_title}} uses the <a href="http://cubes.databrewery.org/">Cubes API</a>, a powerful web data analysis tool.</p><p class="help-block">For most scenarios, use the Cubes slicer endpoint, which provides <a href="https://cubes.readthedocs.org/en/latest/server.html">a flexible set of operations</a>. Cubes uses a transformed version of the main application\'s data model.</p><div class="input-group spaced"><span class="input-group-addon">Cubes API</span> <input class="form-control" readonly="readonly" value="{{config.site_url}}/api/slicer/cube/{{dataset.name}}/model"></div><p class="help-block">If you want to update data in {{config.site_title}} programmatically, use the service endpoint for data sources <a href="https://github.com/pudo/spendb/wiki/Loading-data-via-the-API">and the provided sample code</a>.</p><div class="input-group spaced"><span class="input-group-addon">Data API</span> <input class="form-control" readonly="readonly" value="{{config.site_url}}/api/3/datasets/{{dataset.name}}/sources"></div><p class="help-block">Further notes on the API can be <a href="https://github.com/pudo/spendb/wiki/Web-API">found here</a>.</p></div><div ng-hide="dataset.has_model"><div class="alert alert-warning"><p><strong>Your dataset is incomplete.</strong></p><p>There does not seem to be a valid data model, which is needed to query the data.</p><p>Please continue the setup of your dataset to fix this error.</p><p ng-hide="sources.results"><a class="btn btn-warning" ng-href="/datasets/{{dataset.name}}/upload?mode=wizard">Continue setup</a></p><p ng-show="sources.results"><a class="btn btn-warning" ng-href="/datasets/{{dataset.name}}/sources?mode=wizard">Continue setup</a></p></div></div></div></div></page-body>')}]),angular.module("dataset/delete.html",[]).run(["$templateCache",function(a){a.put("dataset/delete.html",'<div class="modal-header"><button type="button" class="close" ng-click="close()" aria-hidden="true">&times;</button><h4 class="modal-title">Delete: {{dataset.label}}</h4></div><div class="modal-body"><p>Are you sure you want to delete this dataset?</p></div><div class="modal-footer"><button type="button" class="btn btn-default" ng-click="close()">Cancel</button> <button type="button" class="btn btn-danger" ng-click="delete()">Delete</button></div>')}]),angular.module("dataset/dimension_edit.html",[]).run(["$templateCache",function(a){a.put("dataset/dimension_edit.html",'<div class="modal-header"><button type="button" class="close" ng-click="close()" aria-hidden="true">&times;</button><h4 class="modal-title">Dimension configuration</h4></div><form class="form-horizontal dataset-settings" role="form" name="forms.dim" ng-submit="update()"><div class="modal-body"><div class="form-group" ng-class="{\'has-error\': !validLabel(dimension)}"><label class="col-sm-3 control-label" for="label">Label</label><div class="col-sm-9"><input type="text" class="form-control" id="label" name="label" ng-change="updateSlug(dimension)" ng-model="dimension.label"></div></div><div class="form-group" ng-class="{\'has-error\': !validDimensionSlug(dimension)}"><label class="col-sm-3 control-label" for="name">API name</label><div class="col-sm-9"><input type="text" class="form-control" id="name" name="name" ng-focus="breakSlugLink(dimension)" ng-model="dimension.name"><p class="help-block" ng-hide="dimension.$invalidName">Developers will use this name to query your data. It can only contain letters, numbers and underscores.</p><p class="help-block" ng-show="dimension.$invalidName" ng-bind="dimension.$invalidName"></p></div></div><table class="table"><tr><th>Attribute label</th><th>API name</th><th>Source column</th><th width="1%"></th></tr><tr ng-repeat="attribute in dimension.attributes"><td ng-class="{\'has-error\': !validLabel(attribute)}"><input class="form-control" ng-model="attribute.label" ng-change="updateSlug(attribute)"></td><td ng-class="{\'has-error\': !validAttributeSlug(attribute)}"><input class="form-control" ng-model="attribute.name" ng-focus="breakSlugLink(attribute)"></td><td><input class="form-control" ng-model="attribute.column" readonly="readonly"></td><td class="middle"><a ng-show="dimension.attributes.length > 1" ng-click="removeAttribute(attribute)"><i class="fa fa-times"></i></a></td></tr></table><div class="form-group"><label class="col-sm-3 control-label" for="label_attribute">Label attribute</label><div class="col-sm-9"><select name="label_attribute" class="form-control" ng-options="a as a.label for a in dimension.attributes" ng-init="dimension.attributes[0]" ng-model="dimension.label_attribute"></select><p class="help-block">Select the primary attribute that should be shown to the user, e.g. a classification title or company name.</p></div></div><div class="form-group"><label class="col-sm-3 control-label" for="key_attribute">Key attribute</label><div class="col-sm-9"><select name="key_attribute" class="form-control" ng-options="a as a.label for a in dimension.attributes" ng-init="dimension.attributes[0]" ng-model="dimension.key_attribute"></select><p class="help-block">Select the attribute holding the shortest identifier for this dimension, e.g. a classification code. This will not be shown to the user but included in URLs.</p></div></div></div></form><div class="modal-footer"><button type="button" class="btn btn-primary" ng-disabled="!canUpdate()" ng-click="update()">Save</button></div>')}]),angular.module("dataset/dimensions.html",[]).run(["$templateCache",function(a){a.put("dataset/dimensions.html",'<dataset-settings step="6" dataset="dataset" next="save()" next-label="Done" next-active="canSave()" prev="back()" prev-active="true"><div class="row"><div class="col-md-4"><div class="alert guidance"><p>Specify the <mark>dimensions</mark> that the columns in the data describe.</p><p>Group columns that refer to the same concept, like classification schemes, or different fields describing a company.</p><p>If a classification scheme has multiple levels of detail, make these into separate dimensions.</p></div><div><div class="btn-group" role="group" dropdown><button class="btn btn-primary" ng-disabled="!canAdd()" ng-click="addFields()">Create dimension</button> <button type="button" class="btn btn-primary dropdown-toggle" dropdown-toggle ng-disabled="!canAdd() || dimensions.length == 0">Add to dimension <i class="fa fa-chevron-down"></i></button><ul class="dropdown-menu" role="menu"><li ng-repeat="dim in dimensions"><a ng-click="addFields(dim)">{{dim.label}}</a></li></ul></div></div></div><div class="col-md-8"><div ng-repeat="(field, message) in errors" class="alert alert-danger" role="alert"><strong>{{field}}:</strong> {{message}}</div><div class="alert alert-success" ng-hide="getAvailableFields().length"><strong>Looks good!</strong> All source columns are in dimensions, press <em>Done</em> to continue.</div><div ng-show="getAvailableFields().length"><table class="table table-model"><tr><th width="1%"></th><th>Column name</th><th>Samples</th></tr><tbody ng-repeat="field in getAvailableFields()"><tr><td width="1%" class="text-center"><input type="checkbox" ng-model="selectedFields[field.name]"></td><th>{{ field.title }}</th><td width="10%"><button class="btn btn-xs btn-default" ng-hide="field.show_samples" ng-click="toggleSamples(field)"><i class="fa fa-eye"></i> Show</button> <button class="btn btn-xs btn-default" ng-show="field.show_samples" ng-click="toggleSamples(field)"><i class="fa fa-eye-slash"></i> Hide</button></td></tr><tr class="adjunct" ng-show="field.show_samples"><td width="1%" class="text-center"></td><td colspan="2"><span ng-repeat="sample in getSamples(field)"><code>{{sample}}</code><span ng-hide="$last">,</span></span></td></tr></tbody></table></div><div ng-show="dimensions.length" class="panel panel-default"><div class="panel-heading"><h3 class="panel-title">Dataset dimensions</h3><div class="clearfix"></div></div><table class="table"><tr><th>Dimension</th><th>Attributes (Columns)</th><th width="1%">Edit</th><th width="1%">Remove</th></tr><tr ng-repeat="dim in getDimensions()"><th>{{dim.label}}</th><td><span ng-repeat="attr in getAttributes(dim)">{{attr.label}} ({{attr.column}})<span ng-hide="$last">,</span></span></td><td class="text-right"><a class="btn btn-default btn-xs" ng-click="editDimension(dim)"><i class="fa fa-pencil-square-o"></i></a></td><td class="text-right"><a class="btn btn-default btn-xs" ng-click="deleteDimension(dim)"><i class="fa fa-times"></i></a></td></tr></table></div></div></div></dataset-settings>')}]),angular.module("dataset/edit.html",[]).run(["$templateCache",function(a){a.put("dataset/edit.html",'<dataset-settings step="3" dataset="dataset" next="save()" next-active="canSave()" prev="upload()" prev-active="true"><div class="row"><div class="col-md-4"><div class="alert guidance"><p>This additional information is essential for others to know the source and scope of your data.</p></div></div><div class="col-md-8"><form class="form-horizontal" name="forms.dataset"><div class="form-group" ng-hide="wizard" ng-class="{\'has-error\': forms.dataset.label.$invalid}"><label for="label" class="col-sm-2 control-label">Title</label><div class="col-sm-10"><input name="label" ng-model="dataset.label" class="form-control" placeholder="My Dataset"><p class="help-block" ng-show="forms.dataset.label.$invalid" ng-bind="forms.dataset.label.$message"></p><p class="help-block" ng-hide="forms.dataset.label.$invalid">Please make sure the title is informative for users from another country or region.</p></div></div><div class="form-group" ng-class="{\'has-error\': forms.dataset.category.$invalid}"><label for="category" class="col-sm-2 control-label">Category</label><div class="col-sm-10"><ui-select name="category" ng-model="dataset.category" disable-search="true"><ui-select-match placeholder="Pick one...">{{$select.selected.label}}</ui-select-match><ui-select-choices repeat="c.code as c in reference.categories | filter: $select.search track by c.code"><div ng-bind="c.label"></div></ui-select-choices></ui-select><p class="help-block" ng-show="forms.dataset.category.$invalid" ng-bind="forms.dataset.category.$message"></p><p class="help-block" ng-hide="forms.dataset.category.$invalid">Choose <mark>Budget</mark> for high-level budgetary planning and analysis data, or <mark>Expenditure</mark> for fine-grained transactional reports.</p></div></div><div class="form-group" ng-class="{\'has-error\': forms.dataset.currency.$invalid}"><label for="currency" class="col-sm-2 control-label">Currency</label><div class="col-sm-10"><ui-select name="currency" ng-model="dataset.currency"><ui-select-match placeholder="Pick one...">{{$select.selected.label}}</ui-select-match><ui-select-choices repeat="c.code as c in reference.currencies | filter: $select.search track by c.code"><div ng-bind="c.label"></div></ui-select-choices></ui-select><p class="help-block" ng-show="forms.dataset.currency.$invalid" ng-bind="forms.dataset.currency.$message"></p></div></div><div class="form-group" ng-class="{\'has-error\': forms.dataset.territories.$invalid}"><label for="territories" class="col-sm-2 control-label">Countries</label><div class="col-sm-10"><ui-select name="territories" ng-model="dataset.territories" multiple="multiple"><ui-select-match placeholder="Pick one...">{{$item.label}}</ui-select-match><ui-select-choices repeat="t.code as t in reference.territories | filter: $select.search"><div ng-bind="t.label"></div></ui-select-choices></ui-select><p class="help-block" ng-show="forms.dataset.territories.$invalid" ng-bind="forms.dataset.territories.$message"></p><p class="help-block" ng-hide="forms.dataset.territories.$invalid">Please select all countries in which the spending recorded in this data has taken place.</p></div></div><div class="form-group" ng-class="{\'has-error\': forms.dataset.languages.$invalid}"><label for="languages" class="col-sm-2 control-label">Languages</label><div class="col-sm-10"><ui-select name="languages" ng-model="dataset.languages" multiple="multiple"><ui-select-match placeholder="Pick one...">{{$item.label}}</ui-select-match><ui-select-choices repeat="l.code as l in reference.languages | filter: $select.search"><div ng-bind="l.label"></div></ui-select-choices></ui-select><p class="help-block" ng-show="forms.dataset.languages.$invalid" ng-bind="forms.dataset.languages.$message"></p></div></div><div class="form-group" ng-class="{\'has-error\': form.description.$invalid}"><label for="description" class="col-sm-2 control-label">Description</label><div class="col-sm-10"><p class="help-block" ng-show="forms.dataset.description.$invalid" ng-bind="form.description.$message"></p><textarea ng-model="dataset.description" class="xxlarge form-control" rows="4" name="description"></textarea></div></div><div class="form-group" ng-hide="wizard"><label for="label" class="col-sm-2 control-label">Managers</label><div class="col-sm-10"><p class="help-block">A dataset can be managed by more than one user. Please add other users to give them the ability to see unpublished datasets and to edit or delete the dataset.</p><table class="table table-condensed"><tr ng-repeat="manager in managers.managers"><td>{{manager.display_name}}</td><td width="20%" class="numeric"><a ng-hide="manager.name == session.user.name" ng-click="removeAccount(manager)"><i class="fa fa-times"></i></a></td></tr><tr><td colspan="2"><input class="form-control" placeholder="Add another user" ng-model="managers.fresh" typeahead-editable="false" typeahead-on-select="addAccount($item)" typeahead="a as a.display_name for a in suggestAccounts($viewValue)"></td></tr></table></div></div></form></div></div></dataset-settings>')}]),angular.module("dataset/hierarchies.html",[]).run(["$templateCache",function(a){a.put("dataset/hierarchies.html",'<dataset-settings step="7" dataset="dataset" next="save()" next-label="Done" next-active="canSave()" prev="back()" prev-active="true"><div class="row"><div class="col-md-4"><div class="alert guidance"><p>Specify the <mark>dimensions</mark> that the columns in the data describe.</p><p>Group columns that refer to the same concept, like classification schemes, or different fields describing a company.</p><p>If a classification scheme has multiple levels of detail, make these into separate dimensions.</p></div><div class="col-md-8"><div ng-repeat="(field, message) in errors" class="alert alert-danger" role="alert"><strong>{{field}}:</strong> {{message}}</div><div class="alert alert-success" ng-hide="getAvailableFields().length"><strong>Looks good!</strong> All source columns are in dimensions, press <em>Done</em> to continue.</div><div ng-show="getAvailableFields().length"><table class="table table-model"><tr><th width="1%"></th><th>Column name</th><th></th><th>Samples</th></tr><tbody ng-sortable="dimensionConfig"><tr ng-repeat-start="field in getAvailableFields()" class="item"><td width="1%" class="text-center"><input class="ignore-elements" type="checkbox" ng-model="selectedFields[field.name]"></td><th>{{ field.title }}</th><td width="10%" class="ignore-elements"><button class="btn btn-xs btn-default" ng-click="addHierarchy(field)"><i class="fa fa-plus"></i> Add as hierarchy</button></td><td width="10%" class="ignore-elements"><button class="btn btn-xs btn-default" ng-hide="field.show_samples" ng-click="toggleSamples(field)"><i class="fa fa-eye"></i> Show</button> <button class="btn btn-xs btn-default" ng-show="field.show_samples" ng-click="toggleSamples(field)"><i class="fa fa-eye-slash"></i> Hide</button></td></tr><tr ng-repeat-end class="adjunct ignore-elements" ng-show="field.show_samples"><td width="1%" class="text-center"></td><td colspan="2"><span ng-repeat="sample in getSamples(field)"><code>{{sample}}</code><span ng-hide="$last">,</span></span></td></tr></tbody></table></div><div ng-show="dimensions.length" class="panel panel-default"><div class="panel-heading"><h3 class="panel-title">Dataset dimensions</h3><div class="clearfix"></div></div><table class="table"><tr><th>Dimension</th><th>Attributes (Columns)</th><th width="1%">Edit</th><th width="1%">Remove</th></tr><tr ng-repeat="dim in getDimensions()"><th>{{dim.label}}</th><td><span ng-repeat="attr in getAttributes(dim)">{{attr.label}} ({{attr.column}})<span ng-hide="$last">,</span></span></td><td class="text-right"><a class="btn btn-default btn-xs" ng-click="editDimension(dim)"><i class="fa fa-pencil-square-o"></i></a></td><td class="text-right"><a class="btn btn-default btn-xs" ng-click="deleteDimension(dim)"><i class="fa fa-times"></i></a></td></tr></table></div></div><div class="col-md-4" ng-show="hierarchies.length"><div class="dimensions" ng-repeat="hier in getHierarchies()" ng-controller="HierarchyCtrl">{{hier.label}}<ul ng-sortable="hierarchyConfig" class="hierarchy"><li ng-repeat="level in hier.levels track by $index">{{level.name}}</li></ul></div></div></div></div></dataset-settings>')}]),angular.module("dataset/measures.html",[]).run(["$templateCache",function(a){a.put("dataset/measures.html",'<dataset-settings step="5" dataset="dataset" next="save()" next-active="canSave()" prev="back()" prev-active="true"><div class="row"><div class="col-md-4"><div class="alert guidance"><p>Select columns which describe financial amounts. These will be <mark>measures</mark> in your dataset.</p><p>Make sure not to include any code numbers or dates. If a column isn\'t shown as a number, you may have to remove commas and currency signs from the data.</p></div></div><div class="col-md-8"><div ng-repeat="(field, message) in errors" class="alert alert-danger" role="alert"><strong>{{field}}:</strong> {{message}}</div><table class="table table-model"><tr><th width="1%"></th><th>Column name</th><th>Samples</th></tr><tbody ng-repeat="field in fields" ng-if="field.numeric"><tr class="middle"><td width="1%" class="text-center"><input type="checkbox" ng-click="toggleMeasure(field)" ng-checked="field.measure"></td><th><span ng-hide="field.measure">{{field.title}}</span> <span ng-show="field.measure" ng-class="{\'has-error\': !validLabel(field)}"><div class="input-group"><span class="input-group-addon">Label</span> <input ng-model="field.measure.label" class="form-control" ng-change="updateSlug(field)"></div></span></th><td width="10%"><button class="btn btn-xs btn-default" ng-hide="field.show_samples" ng-click="toggleSamples(field)"><i class="fa fa-eye"></i> Show</button> <button class="btn btn-xs btn-default" ng-show="field.show_samples" ng-click="toggleSamples(field)"><i class="fa fa-eye-slash"></i> Hide</button></td></tr><tr class="middle adjunct" ng-show="field.measure"><td width="1%" class="text-center"></td><td><div class="input-group" ng-class="{\'has-error\': !validSlug(field)}"><span class="input-group-addon">API name</span> <input ng-model="field.measure.name" class="form-control" ng-focus="breakSlugLink(field)"></div></td><td></td></tr><tr class="adjunct" ng-show="field.show_samples"><td width="1%" class="text-center"></td><td colspan="2"><span ng-repeat="sample in getSamples(field)"><code>{{sample}}</code><span ng-hide="$last">,</span></span></td></tr></tbody><tr><th colspan="3">Non-numeric columns (cannot be <mark>measures</mark>)</th></tr><tbody ng-repeat="field in fields" ng-if="!field.numeric"><tr><td width="1%" class="text-center"></td><th>{{field.title}}</th><td width="10%"><button class="btn btn-xs btn-default" ng-hide="field.show_samples" ng-click="toggleSamples(field)"><i class="fa fa-eye"></i> Show</button> <button class="btn btn-xs btn-default" ng-show="field.show_samples" ng-click="toggleSamples(field)"><i class="fa fa-eye-slash"></i> Hide</button></td></tr><tr class="adjunct" ng-show="field.show_samples"><td width="1%" class="text-center"></td><td colspan="2"><span ng-repeat="sample in getSamples(field)"><code>{{sample}}</code><span ng-hide="$last">,</span></span></td></tr></tbody></table></div></div></dataset-settings>');
}]),angular.module("dataset/new.html",[]).run(["$templateCache",function(a){a.put("dataset/new.html",'<div ng-hide="session.logged_in"><page-header></page-header><page-body><div class="row"><div class="col-md-offset-3 col-md-6"><div class="alert guidance"><p>We\'re gathering <strong>the world\'s government spending information</strong> in a common database so that we can provide great tools for <strong>analysis, visualization and comparison</strong>.</p><p>Our goal is an open platform that aims to facilitate the presentation of financial information so anyone - whether data geek or concerned citizen - can contribute their local city budget or spending reports.</p></div><div class="btn-group" role="group"><a href="/login" class="btn btn-lg btn-primary">Sign up to contribute</a> <a href="/docs/about.html" class="btn btn-lg btn-default">Learn more</a></div></div></div></page-body></div><div ng-show="session.logged_in"><dataset-settings step="1" next="createDataset()" next-active="canCreate()"><div class="row"><div class="col-md-4"><div class="alert guidance"><p>Thanks for contributing! To get started, select a name and identifier for your dataset.</p></div></div><div class="col-md-8"><form class="form-horizontal" name="forms.dataset" ng-submit="createDataset()"><div class="form-group form-group-lg" ng-class="{\'has-error\': forms.dataset.label.$invalid}"><label for="label" class="col-sm-2 control-label">Title</label><div class="col-sm-10"><input name="label" ng-model="dataset.label" class="form-control" placeholder="My Dataset" autocomplete="off"><p class="help-block" ng-show="forms.dataset.label.$invalid" ng-bind="forms.dataset.label.$message"></p></div></div><div class="form-group" ng-class="{\'has-error\': forms.dataset.name.$invalid}"><label for="name" class="col-sm-2 control-label">URL</label><div class="col-sm-10"><div class="input-group input-group-sm"><span class="input-group-addon" id="base-url">{{baseUrl}}</span> <input name="name" ng-model="dataset.name" class="form-control" placeholder="my-dataset" ng-readonly="hasDataset()" ng-focus="editSlug()"></div><p class="help-block" ng-show="forms.dataset.name.$invalid" ng-bind="forms.dataset.name.$message"></p><p class="help-block" ng-hide="forms.dataset.name.$invalid">The identifier cannot be changed later. It can only contain letters, numbers and dashes.</p></div></div></form></div></div></dataset-settings></div>')}]),angular.module("dataset/query.html",[]).run(["$templateCache",function(a){a.put("dataset/query.html",'<page-header dataset="dataset" section="query"></page-header><page-body><babbage-workspace endpoint="/api/babbage/" cube="{{dataset.name}}"></babbage-workspace></page-body>')}]),angular.module("dataset/sources.html",[]).run(["$templateCache",function(a){a.put("dataset/sources.html",'<dataset-settings step="4" dataset="dataset" next="continue()" next-active="canContinue()" prev="back()" prev-active="true"><div class="row"><div class="col-md-4"><div class="alert guidance"><p ng-show="wizard">Since you\'ve uploaded your information source, we\'ve started to upload and analyze the data.</p><p>If the file has failed to load, please check the processing details and upload a fixed version.</p></div></div><div class="col-md-8"><div ng-hide="hasSource()"><div class="spinner"><i class="fa fa-spinner fa-pulse"></i></div><p class="text-center">Please wait, your data is still being processed...</p></div><div class="alert alert-success" ng-show="canContinue() && wizard"><strong>Looks good!</strong> Your data seems to have loaded correctly, press <em>Next</em> to continue.</div><div class="panel panel-default" ng-show="hasSource()"><table class="table"><tr><th>File</th><th>Tasks</th><th width="10%">Status</th></tr><tr ng-repeat="run in source.runs"><td><span ng-show="$first">{{source.name}}</span></td><td>{{run.operation}}</td><td><div class="label label-success" ng-show="run.status == \'complete\'">OK</div><div class="label label-warning" ng-show="run.status == \'running\'"><i class="fa fa-spinner fa-spin"></i> Running</div><div class="label label-danger" ng-show="run.status == \'failed\'">Failed</div></td></tr><tr ng-show="errors.total" colspan="3"><table class="table table-condensed"><tr ng-repeat="msg in errors.messages" ng-class="LOGLEVELS[msg.level]"><td>{{msg.level}}</td><td class="log-message">{{msg.message}}</td></tr></table></tr></table><div class="panel-footer"><div class="pull-right"><a href="{{source.data_url}}" target="_self" class="btn btn-default" ng-hide="wizard"><i class="fa fa-download"></i> Download ({{source.extension || source.mime_type}})</a> <button class="btn btn-default" ng-click="upload()"><i class="fa fa-cloud-upload"></i> Replace source data</button></div><div class="clearfix"></div></div></div></div></div></dataset-settings>')}]),angular.module("dataset/upload.html",[]).run(["$templateCache",function(a){a.put("dataset/upload.html",'<dataset-settings step="2" dataset="dataset" next="continue()" next-active="canContinue()" prev-active="false"><div class="row"><div class="col-md-4"><div class="alert guidance"><p ng-show="wizard">Great. Now please tell us where we can find the data which you are contributing.</p><p>The submitted data must be in CSV, Excel or LibreOffice format - other formats, such as PDF or Word documents will not work.</p></div></div><div class="col-md-8"><div class="row"><div class="col-md-6"><form><div class="form-group"><label for="file">Upload source data file</label><span ng-hide="uploadPercent"><div class="input-group" ngf-select ngf-change="setFile($files, $event)"><input type="text" class="form-control" ng-model="file.name" readonly="readonly"> <span class="input-group-btn"><span class="btn btn-default">Browse</span></span></div><p class="help-block">Upload a file from your computer.</p></span><div class="progress" ng-show="uploadPercent"><div class="progress-bar" role="progressbar" aria-valuenow="{{uploadPercent}}" aria-valuemin="0" aria-valuemax="100" style="width: {{uploadPercent}}%"><span class="sr-only">{{uploadPercent}}% Complete</span></div></div></div></form></div><div class="col-md-6"><form><div class="form-group"><label for="url">Load from a web address</label><input type="text" class="form-control" ng-model="urlForm.url" id="url" placeholder="http://.../data.csv" ng-disabled="hasFile()"><p class="help-block">Please give a direct link to the source data, not a landing page or Dropbox file viewer.</p></div></form></div></div></div></div></dataset-settings>')}]),angular.module("directives/dataset_list.html",[]).run(["$templateCache",function(a){a.put("directives/dataset_list.html",'<ul class="list-group list-datasets"><li class="list-group-item" ng-repeat="ds in datasets.results"><strong><a ng-href="{{getDatasetLink(ds)}}">{{ds.label}} <span ng-show="ds.private"><i class="fa fa-eye-slash" tooltip="This dataset is private" tooltip-placement="bottom"></i></span></a></strong> <span ng-show="ds.currency" class="help-block">({{ds.currency}})</span> <span ng-show="ds.description" class="help-block">&middot; {{ds.description | truncate:140:\'...\':true }}</span></li></ul><response-pager response="datasets" load="load(offset)"></response-pager>')}]),angular.module("directives/dataset_settings.html",[]).run(["$templateCache",function(a){a.put("directives/dataset_settings.html",'<page-header dataset="navDataset" section="manage"></page-header><div class="wizard-progress" ng-show="wizard"><ul class="pagination pagination-sm"><li ng-class="{\'active\': _step == 1, \'seen\': _step > 1}"><a>New dataset</a></li><li ng-class="{\'active\': _step == 2, \'seen\': _step > 2}"><a>Source data</a></li><li ng-class="{\'active\': _step == 3, \'seen\': _step > 3}"><a>Metadata</a></li><li ng-class="{\'active\': _step == 4, \'seen\': _step > 4}"><a>Data check-up</a></li><li ng-class="{\'active\': _step == 5, \'seen\': _step > 5}"><a>Measures</a></li><li ng-class="{\'active\': _step == 6, \'seen\': _step > 6}"><a>Dimensions</a></li><li><a>Done</a></li></ul></div><page-body><div class="dataset-settings"><div ng-transclude></div></div><hr><div class="pull-right"><button ng-show="wizard" class="btn btn-default btn-lg" ng-click="next()" ng-disabled="!nextActive()">{{_nextLabel}} <i class="fa fa-chevron-circle-right"></i></button> <button ng-hide="wizard" class="btn btn-default btn-lg" ng-click="next()" ng-disabled="!nextActive()">Save</button></div><div class="pull-left" ng-show="prevShow"><button class="btn btn-default btn-lg" ng-click="prev()" ng-disabled="!prevActive"><i class="fa fa-chevron-circle-left"></i> {{_prevLabel}}</button></div></page-body>')}]),angular.module("directives/page_body.html",[]).run(["$templateCache",function(a){a.put("directives/page_body.html",'<div class="container-fluid"><div ng-transclude></div></div>')}]),angular.module("directives/page_header.html",[]).run(["$templateCache",function(a){a.put("directives/page_header.html",'<div class="navbar navbar-default navbar-static-top" data-dropdown="dropdown"><div class="navbar-inner"><div class="container-fluid"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-collapse"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/" ng-hide="home_page"><div class="navbar-brand-button"><i class="fa fa-chevron-left"></i></div></a> <span class="navbar-brand"><span ng-bind="title"></span> <span ng-show="dataset && dataset.private"><i class="fa fa-eye-slash" tooltip="This dataset is private" tooltip-placement="bottom"></i></span></span></div><div class="collapse navbar-collapse" id="main-collapse"><ul class="nav navbar-nav" ng-show="session.logged_in && home_page"><li><a href="/datasets/new">Create a dataset</a></li></ul><ul class="nav navbar-nav" ng-show="dataset"><li ng-class="{\'active\': section == \'query\'}"><a ng-href="/datasets/{{dataset.name}}">Query</a></li><li ng-class="{\'active\': section == \'about\'}"><a ng-href="/datasets/{{dataset.name}}/about">About</a></li><li dropdown ng-class="{\'active\': section == \'manage\'}" ng-show="dataset.can_update"><a dropdown-toggle>Manage <i class="fa fa-caret-down"></i></a><ul class="dropdown-menu account-dropdown" role="menu"><li><a ng-href="/datasets/{{dataset.name}}/edit">Metadata</a></li><li><a ng-href="/datasets/{{dataset.name}}/sources">Data sources and upload</a></li><li><a ng-href="/datasets/{{dataset.name}}/model/measures">Edit measures</a></li><li><a ng-href="/datasets/{{dataset.name}}/model/dimensions">Edit dimensions</a></li><li class="divider"></li><li ng-show="dataset.private"><a ng-click="togglePrivate()" class="clickable"><strong>Publish</strong></a></li><li ng-hide="dataset.private"><a ng-click="togglePrivate()" class="clickable">Retract</a></li><li><a ng-click="deleteDataset()" class="clickable">Delete</a></li></ul></li></ul><ul class="nav navbar-nav navbar-right" ng-cloak><li class="dropdown" dropdown ng-show="session.logged_in"><a class="dropdown-toggle" dropdown-toggle data-toggle="dropdown"><strong>{{ session.user.display_name }}</strong> <img ng-if="session.user.gravatar" ng-src="{{ session.user.gravatar }}?s=24" width="26" height="26" alt="{{ session.user.display_name }}"></a><ul class="dropdown-menu account-dropdown" role="menu"><li><a ng-href="/accounts/{{session.user.name}}">Dashboard</a></li><li><a href="/settings">Settings</a></li><li class="divider"></li><li><a ng-click="logout()" class="clickable">Logout</a></li></ul></li><li ng-hide="session.logged_in"><a href="/login">Login/Register</a></li></ul></div></div></div></div><div ng-hide="!flash.getMessage()" class="alert-flash alert alert-{{flash.getType()}}"><p>{{flash.getMessage()}}</p></div>')}]),angular.module("directives/response_pager.html",[]).run(["$templateCache",function(a){a.put("directives/response_pager.html",'<ul ng-show="showPager" class="pagination pagination-cursors"><li ng-if="response.prev_url"><a class="ng-link" ng-click="load({offset: offset})">&laquo;</a></li><li ng-repeat="page in pages" ng-class="{\'active\': page.current}"><a class="ng-link" ng-click="load({offset: page.offset})">{{page.page}}</a></li><li ng-if="response.next_url"><a class="ng-link" ng-click="load({offset: offset + response.limit})">&raquo;</a></li></ul>')}]),angular.module("docs.html",[]).run(["$templateCache",function(a){a.put("docs.html",'<page-header></page-header><div class="container"><div class="row docs"><div class="col-md-8 docs-text" ng-bind-html="page_html"></div><div class="col-md-4 docs-menu"><ul class="nav nav-pills nav-stacked"><li ng-repeat="(path, p) in page.pages" ng-hide="p.hidden" ng-class="{\'active\': path == page.path}"><a ng-href="/docs/{{path}}">{{p.title}}</a></li></ul></div></div></div>')}]),angular.module("home.html",[]).run(["$templateCache",function(a){a.put("home.html",'<page-header></page-header><div class="jumbotron" ng-hide="session.logged_in"><div class="container"><h1>Mapping the money</h1><div class="call-to-action"><p ng-bind-html="page_html"></p><p><div class="btn-group"><a class="btn btn-primary btn-lg" href="/datasets/new" role="button">Import your data</a> <a class="btn btn-default btn-lg" ng-click="scrollToDatasets()" role="button">Browse</a> <a class="btn btn-default btn-lg" href="/docs/about.html" role="button">Learn more</a></div></p></div></div></div><page-body><div class="row" id="datasets"><div class="col-md-8"><dataset-list datasets="datasets"></dataset-list></div><div class="col-md-4"><div class="panel panel-default panel-facet"><div class="panel-heading">Countries covered</div><div class="list-group"><a class="list-group-item ng-link" ng-repeat="t in datasets.territories" ng-class="{\'active\': hasFacet(\'territories\', t.code)}" ng-click="toggleFacet(\'territories\', t.code)"><span class="badge">{{t.count}}</span> {{t.label}}</a></div></div><div class="panel panel-default panel-facet"><div class="panel-heading">Languages</div><div class="list-group"><a class="list-group-item ng-link" ng-repeat="l in datasets.languages" ng-class="{\'active\': hasFacet(\'languages\', l.code)}" ng-click="toggleFacet(\'languages\', l.code)"><span class="badge">{{l.count}}</span> {{l.label}}</a></div></div></div></div></page-body>')}]),angular.module("spendb.config",[]).constant("config",SPENDB_CONFIG);var spendb=angular.module("spendb",["spendb.config","spendb.templates","ngCookies","ngRoute","angular.filter","duScroll","ngFileUpload","ui.bootstrap","ui.select","ngBabbage"]);spendb.constant("config",{appName:"SpenDB",appVersion:1,apiBaseUrl:""}),spendb.config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"home.html",controller:"HomeCtrl",reloadOnSearch:!0,resolve:{session:loadSession,page:loadIndex,datasets:loadIndexDatasets}}),a.when("/docs/:path",{templateUrl:"docs.html",controller:"DocsCtrl",resolve:{page:loadPage}}),a.when("/login",{templateUrl:"account/login.html",controller:"AccountLoginCtrl",resolve:{}}),a.when("/settings",{templateUrl:"account/settings.html",controller:"AccountSettingsCtrl",resolve:{session:loadSession,account:loadSessionAccount}}),a.when("/accounts/:account",{templateUrl:"account/profile.html",controller:"AccountProfileCtrl",reloadOnSearch:!0,resolve:{profile:loadProfile}}),a.when("/datasets",{templateUrl:"dataset/index.html",controller:"DatasetIndexCtrl",reloadOnSearch:!0,resolve:{datasets:loadIndexDatasets}}),a.when("/datasets/new",{templateUrl:"dataset/new.html",controller:"DatasetNewCtrl",resolve:{session:loadSession,reference:loadReferenceData}}),a.when("/datasets/:dataset",{templateUrl:"dataset/query.html",controller:"DatasetQueryCtrl",reloadOnSearch:!1,resolve:{dataset:loadDataset}}),a.when("/datasets/:dataset/about",{templateUrl:"dataset/about.html",controller:"DatasetAboutCtrl",resolve:{dataset:loadDataset,managers:loadManagers,model:loadModel,sources:loadSources,reference:loadReferenceData}}),a.when("/datasets/:dataset/upload",{templateUrl:"dataset/upload.html",controller:"DatasetUploadCtrl",resolve:{dataset:loadDataset}}),a.when("/datasets/:dataset/edit",{templateUrl:"dataset/edit.html",controller:"DatasetEditCtrl",resolve:{session:loadSession,dataset:loadDataset,reference:loadReferenceData,managers:loadManagers}}),a.when("/datasets/:dataset/sources",{templateUrl:"dataset/sources.html",controller:"DatasetSourcesCtrl",resolve:{dataset:loadDataset}}),a.when("/datasets/:dataset/model/measures",{templateUrl:"dataset/measures.html",controller:"DatasetMeasuresCtrl",resolve:{dataset:loadDataset,data:loadModel}}),a.when("/datasets/:dataset/model/dimensions",{templateUrl:"dataset/dimensions.html",controller:"DatasetDimensionsCtrl",resolve:{dataset:loadDataset,data:loadModel}}),a.otherwise({redirectTo:"/"}),b.html5Mode(!0)}]),spendb.controller("AppCtrl",["$scope","$rootScope","$location","$http","$cookies","$window","$document","$sce","session","config",function(a,b,c,d,e,f,g,h,i,j){a.showCookieWarning=!e.neelieCookie,a.showSpinner=!0,b.$on("$routeChangeStart",function(b,c,d){a.showSpinner=!0}),b.$on("$routeChangeSuccess",function(b,c,d){a.showSpinner=!1}),b.$on("$routeChangeError",function(b,c,d){a.showSpinner=!1}),a.hideCookieWarning=function(){e.neelieCookie=!0,a.showCookieWarning=!e.neelieCookie},i.get(function(b){b.logged_in&&a.hideCookieWarning()}),a.setLocale=function(a){return d.post("/set-locale",{locale:a}).then(function(a){f.location.reload()}),!1},b.setTitle=function(a){b.currentTitle=a,angular.element(document.getElementsByTagName("title")).html(a+" - "+j.site_title)},a.resetScroll=function(){var a=angular.element(document.getElementsByTagName("body"));g.scrollToElement(a,0,300)},a.scrollToId=function(a){var b=angular.element(document.getElementById(a));g.scrollToElement(b,0,200)},a.trustAsHtml=function(a){return h.trustAsHtml(""+a)}}]);var loadPage=["$q","$route","$http","config",function(a,b,c,d){var e=a.defer();return c.get(d.apiBaseUrl+"/api/3/pages/"+b.current.params.path).then(function(a){e.resolve(a.data)}),e.promise}];spendb.controller("DocsCtrl",["$scope","$sce","page",function(a,b,c){a.setTitle(c.title),a.page=c,a.page_html=b.trustAsHtml(""+c.html)}]),spendb.controller("AccountLoginCtrl",["$scope","$modal","$http","$location","validation","session","config",function(a,b,c,d,e,f,g){a.setTitle("Login and registration"),a.credentials={},a.account={},a.login=function(b){var h=angular.copy(a.credentials);a.credentials.password="",c.post(g.apiBaseUrl+"/api/3/sessions/login",h).then(function(b){f.flush(),d.path("/accounts/"+a.credentials.login)},e.handle(b))},a.register=function(b){c.post(g.apiBaseUrl+"/api/3/accounts",a.account).then(function(b){f.flush(),d.path("/accounts/"+a.account.name)},e.handle(b))},a.resetPassword=function(){b.open({templateUrl:"account/reset.html",controller:"AccountResetCtrl",backdrop:!0,resolve:{}})}}]);var loadProfile=["$q","$http","$location","$route","config",function(a,b,c,d,e){var f=(e.apiBaseUrl+"/api/3/accounts/"+d.current.params.account,a.defer()),g=d.current.params.account,h=angular.extend({},c.search(),{account:g});return a.all([b.get(e.apiBaseUrl+"/api/3/accounts/"+g),b.get(e.apiBaseUrl+"/api/3/datasets",{params:h})]).then(function(a){f.resolve({account:a[0].data,datasets:a[1].data})}),f.promise}];spendb.controller("AccountProfileCtrl",["$scope","$http","$location","session","profile",function(a,b,c,d,e){a.setTitle(e.account.display_name),a.account=e.account,a.own_profile=!1,a.datasets=e.datasets,d.get(function(b){a.own_profile=b.logged_in&&b.user.name==e.account.name})}]),spendb.controller("AccountResetCtrl",["$scope","$modalInstance","$window","$location","$http","config",function(a,b,c,d,e,f){a.data={},a.res={},a.sent=!1,a.close=function(){b.dismiss("ok")},a.send=function(){a.sent=!0,e.post(f.apiBaseUrl+"/api/3/reset",a.data).then(function(b){a.res=b.data},function(b){a.res=b.data,a.sent=!1})}}]);var loadSessionAccount=["$q","$http","session","config",function(a,b,c,d){var e=a.defer();return c.get(function(a){b.get(d.apiBaseUrl+"/api/3/accounts/"+a.user.name).then(function(a){e.resolve(a.data)})}),e.promise}];spendb.controller("AccountSettingsCtrl",["$scope","$http","$location","validation","account","flash","session",function(a,b,c,d,e,f,g){a.setTitle("Account Settings"),a.account=e,a.session=g,a.save=function(c){b.post(e.api_url,a.account).then(function(a){f.setMessage("Your changes have been saved!","success"),d.clear(c)},d.handle(c))}}]),spendb.controller("DatasetCtrl",["$scope","$rootScope","$http","$modal","config",function(a,b,c,d,e){a.currentSection="home",a.dataset=e.dataset,b.setSection=function(b){a.currentSection=b},a.deleteDataset=function(){d.open({templateUrl:"admin/delete.html",controller:"AdminDeleteCtrl",backdrop:!0,resolve:{dataset:function(){return a.dataset}}})},a.togglePrivate=function(){a.dataset["private"]=!a.dataset["private"],c.post(a.dataset.api_url,a.dataset).then(function(b){a.dataset=b.data})}}]),spendb.controller("DatasetAboutCtrl",["$scope","$location","$http","dataset","model","managers","sources","config","reference",function(a,b,c,d,e,f,g,h,i){a.setTitle(d.label),a.dataset=d,a.managers=f,a.model=e.model,a.config=h,a.sources=g,a.getReferenceLabel=function(a,b){for(var c in i[a]){var d=i[a][c];if(d.code==b)return d.label}return b}}]),spendb.controller("DatasetDeleteCtrl",["$scope","$modalInstance","$window","$location","$http","dataset",function(a,b,c,d,e,f){a.dataset=f,a.close=function(){b.dismiss("cancel")},a["delete"]=function(){e["delete"](a.dataset.api_url).error(function(a){d.path("/"),b.close("ok")})}}]),spendb.controller("DatasetDimensionEditCtrl",["$scope","$modalInstance","$window","$location","$http","slugifyFilter","dimension","dimensions",function(a,b,c,d,e,f,g,h){a.dimension=g,a.removeAttribute=function(b){var c=a.dimension.attributes.indexOf(b);(-1!=c||a.dimension.attributes.length>1)&&(a.dimension.attributes.splice(c,1),a.dimension.label_attribute==b&&(a.dimension.label_attribute=a.dimension.attributes[0]),a.dimension.key_attribute==b&&(a.dimension.key_attribute=a.dimension.attributes[0]))},a.breakSlugLink=function(a){a.slug_linked=!1},a.updateSlug=function(a){a.slug_linked&&(a.name=f(a.label,"_"))},a.validLabel=function(a){return!a||!a.label||a.label.length<2?!1:!0};var i=function(a){return!a||!a.name||a.name.length<2?!1:a.name!=f(a.name,"_")?!1:!0};a.validAttributeSlug=function(b){if(!i(b))return!1;for(var c in a.dimension.attributes){var d=a.dimension.attributes[c];if(d!=b&&d.name==b.name)return!1}return!0},a.validDimensionSlug=function(a){if(a.$invalidName=null,!i(a))return!1;for(var b in h){var c=h[b];if(c!=a&&c.name==a.name)return a.$invalidName="A dimension with this name already exists.",!1}return!0},a.canUpdate=function(){if(!a.validDimensionSlug(a.dimension))return!1;if(!a.validLabel(a.dimension))return!1;for(var b in a.dimension.attributes){var c=a.dimension.attributes[b];if(!a.validAttributeSlug(c))return!1;if(!a.validLabel(c))return!1}return!0},a.update=function(){a.canUpdate&&b.close(a.dimension)},a.close=function(){b.dismiss("ok")}}]),spendb.controller("DatasetDimensionsCtrl",["$scope","$modal","$http","$location","$q","slugifyFilter","flash","validation","dataset","data",function(a,b,c,d,e,f,g,h,i,j){a.dataset=i,a.selectedFields={},a.dimensions=[];var k=function(b){var c=(b.measures||{},b.dimensions||{}),d=[];for(var e in c){var f=c[e];f.name=e,f.slug_linked=!1;var g=f.attributes||{},h=[];for(var i in g){var j=g[i];j.name=i,j.slug_linked=!1,i==f.label_attribute&&(f.label_attribute=j),i==f.key_attribute&&(f.key_attribute=j),h.push(j)}f.attributes=h,d.push(f)}a.dimensions=d},l=function(){var b={};for(var c in a.dimensions){var d=angular.copy(a.dimensions[c]),e={};for(var f in d.attributes){var g=d.attributes[f];e[g.name]=g}d.attributes=e,d.label_attribute=d.label_attribute.name,d.key_attribute=d.key_attribute.name,b[d.name]=d}var h=angular.copy(j.model)||{};return h.dimensions=b,h};a.getAvailableFields=function(){var b=[],c=j.model.measures||{};for(var d in j.structure.fields){var e=j.structure.fields[d],f=!0;for(var g in c){var h=c[g];h.column==e.name&&(f=!1)}if(f)for(var g in a.dimensions){var i=a.dimensions[g];for(var k in i.attributes){var l=i.attributes[k];l.column==e.name&&(f=!1)}}f&&b.push(e)}return b.sort(function(a,b){return a.title.localeCompare(b.title)})},a.toggleSamples=function(a){a.show_samples=!a.show_samples},a.canAdd=function(){for(var b in a.selectedFields)if(a.selectedFields[b])return!0;return!1},a.addFields=function(b){b=b||{},b.attributes=b.attributes||[];var c=[];for(var d in a.selectedFields)if(a.selectedFields[d])for(var e in j.structure.fields){var g=j.structure.fields[e];g.name==d&&(b.attributes.push({name:g.name,column:g.name,label:g.title,slug_linked:!0}),c.push(g.title),delete a.selectedFields[d])}var h=!angular.isDefined(b.name);if(h){b.slug_linked=!0;var i=longestCommonStart(c),k=i.length?i.charAt(i.length-1):" ",l=new RegExp(/[\W_]/g).test(k);if(b.label=cleanLabel(l||1==c.length?i:""),b.name=f(b.label,"_"),l)for(var e in b.attributes){var m=b.attributes[e];-1!=c.indexOf(m.label)&&i.length<m.label.length&&(m.label=cleanLabel(m.label.slice(i.length)),m.name=f(m.label,"_"))}}a.editDimension(b)},a.editDimension=function(c){var d=angular.copy(c);d.attributes=d.attributes.sort(function(a,b){return a.label.localeCompare(b.label)}),d.label_attribute||(d.label_attribute=d.attributes[0]),d.key_attribute||(d.key_attribute=d.attributes[0]);var e=b.open({templateUrl:"dataset/dimension_edit.html",controller:"DatasetDimensionEditCtrl",backdrop:!0,resolve:{dimension:function(){return d},dimensions:function(){var b=[];for(var d in a.dimensions){var e=a.dimensions[d];e!=c&&b.push(e)}return b}}});e.result.then(function(b){a.deleteDimension(c),a.dimensions.push(b)})},a.deleteDimension=function(b){var c=a.dimensions.indexOf(b);-1!=c&&a.dimensions.splice(c,1)},a.getDimensions=function(){return a.dimensions.sort(function(a,b){return a.label.localeCompare(b.label)})},a.getAttributes=function(a){return a.attributes.sort(function(a,b){return a.label.localeCompare(b.label)})},a.getSamples=function(a){return a.samples.sort(function(a,b){return a-b})},a.back=function(){d.path("/datasets/"+i.name+"/model/measures")},a.canSave=function(){return!0},a.save=function(){var b=l();a.errors={},c.post(i.api_url+"/model",b).then(function(b){if(k(b.data),a.wizard){var e=angular.copy(i);e["private"]=!1,c.post(i.api_url,e).then(function(){d.search({}),d.path("/datasets/"+i.name),g.setMessage("That's it! Your dataset is now ready for use.","success")})}else g.setMessage("Your changes have been saved!","success");a.resetScroll()},function(b){a.errors=b.data.errors,a.resetScroll()})},k(j.model||{})}]),spendb.controller("DatasetEditCtrl",["$scope","$document","$http","$location","$q","flash","reference","validation","dataset","managers","session","config",function(a,b,c,d,e,f,g,h,i,j,k,l){a.dataset=i,a.reference=g,a.managers=j,a.forms={},a.session=k,a.suggestAccounts=function(b){var d=e.defer(),f={q:b};return c.get(l.apiBaseUrl+"/api/3/accounts/_complete",{params:f}).then(function(b){var c=[];for(var e in b.data.results){var f=b.data.results[e],g=!1;for(var h in a.managers.managers){var i=a.managers.managers[h];i.name==f.name&&(g=!0)}g||c.push(f)}d.resolve(c)}),d.promise},a.addAccount=function(){a.managers.fresh&&a.managers.fresh.name&&(a.managers.managers.push(a.managers.fresh),a.managers.fresh=null)},a.removeAccount=function(b){var c=a.managers.managers.indexOf(b);-1!=c&&a.managers.managers.splice(c,1)},a.canSave=function(){return!0},a.upload=function(){d.path("/datasets/"+i.name+"/upload")},a.save=function(){var b=c.post(i.api_url,a.dataset);h.clear(a.forms.dataset),b.then(function(b){a.dataset=b.data,c.post(i.api_url+"/managers",a.managers).then(function(b){a.managers=b.data,a.wizard?d.path("/datasets/"+i.name+"/sources"):f.setMessage("Your changes have been saved!","success"),a.resetScroll()})},h.handle(a.forms.dataset))}}]),spendb.controller("DatasetMeasuresCtrl",["$scope","$rootScope","$http","$location","$q","slugifyFilter","flash","validation","dataset","data",function(a,b,c,d,e,f,g,h,i,j){a.dataset=i,a.columns=[],a.fields=[],a.errors={},a.back=function(){d.path("/datasets/"+i.name+"/sources")};var k=function(a){return"integer"==a.type||"number"==a.type},l=function(){var b=j.model,c=b.measures||{},d=[];for(var e in j.structure.fields){var f=j.structure.fields[e];f.numeric=k(f),f.slug_linked=!0;for(var g in c){var h=c[g];h.column==f.name&&(h.name=g,f.slug_linked=!1,f.measure=h)}d.push(f)}a.fields=d.sort(function(a,b){return a.title.localeCompare(b.title)})},m=function(){var b={};for(var c in a.fields){var d=a.fields[c];d.measure&&(b[d.measure.name]={label:d.measure.label,column:d.name,description:d.measure.description})}var e=angular.copy(j.model)||{};return e.dimensions=e.dimensions||{},e.measures=b,e};a.toggleIgnore=function(a){a.ignore=!a.ignore},a.toggleSamples=function(a){a.show_samples=!a.show_samples},a.getSamples=function(a){return a.samples.sort(function(a,b){return a-b})},a.toggleMeasure=function(a){if(a.measure)delete a.measure;else{var b=cleanLabel(a.title);a.measure={name:f(b,"_"),label:b}}},a.breakSlugLink=function(a){a.slug_linked=!1},a.updateSlug=function(a){a.slug_linked&&(a.measure.name=f(a.measure.label,"_"))},a.validLabel=function(a){return!a.measure||!a.measure.label||a.measure.label.length<2?!1:!0},a.validSlug=function(b){if(!b.measure||!b.measure.name||b.measure.name.length<2)return!1;if(b.measure.name!=f(b.measure.name,"_"))return!1;for(var c in a.fields){var d=a.fields[c];if(d.measure&&b.name!=d.name&&d.measure.name==b.measure.name)return!1}return!0},a.canSave=function(){for(var b in a.fields){var c=a.fields[b];if(c.measure)return!0}return!1},a.save=function(){var b=m();console.log("Saving",b),a.errors={},c.post(i.api_url+"/model",b).then(function(b){a.wizard?d.path("/datasets/"+i.name+"/model/dimensions"):g.setMessage("Your changes have been saved!","success"),a.resetScroll()},function(b){a.errors=b.data.errors,a.resetScroll()})},l()}]),spendb.controller("DatasetNewCtrl",["$scope","$rootScope","$http","$location","slugifyFilter","config","validation","session","config",function(a,b,c,d,e,f,g,h,f){var i=!0;b.setTitle("Create a new dataset"),a.baseUrl=f.site_url+"/datasets/",a.forms={},a.session=h,a.editSlug=function(){i=!1},a.$watch("dataset.label",function(b){i&&b&&(a.dataset.name=e(b,"-"))}),a.dataset={category:"budget",territories:[],"private":!0},a.createDataset=function(){g.clear(a.forms.dataset),c.post(f.apiBaseUrl+"/api/3/datasets",a.dataset).then(function(b){a.dataset=b.data,d.search({mode:"wizard"}),d.path("/datasets/"+b.data.name+"/upload")},g.handle(a.forms.dataset))},a.canCreate=function(){return a.dataset.label&&a.dataset.label.length>=2}}]),spendb.controller("DatasetQueryCtrl",["$scope","$location","dataset",function(a,b,c){a.setTitle(c.label),a.dataset=c,c.has_model||(b.path("/datasets/"+c.name+"/about"),b.search({}))}]);var loadRun=["$route","$q","$http","config",function(a,b,c,d){var e=a.current.params,f=d.apiBaseUrl+"/api/3/datasets/"+e.dataset+"/runs/"+e.run;return c.get(f)}];spendb.controller("DatasetSourcesCtrl",["$scope","$document","$http","$location","$timeout","flash","dataset",function(a,b,c,d,e,f,g){var h=g.api_url+"/sources",i=null;a.LOGLEVELS={WARNING:"warning",ERROR:"danger"},a.dataset=g,a.source={},a.errors={},a.hasSource=function(){return angular.isDefined(a.source.api_url)},a.canContinue=function(){if(!a.source.runs||0==a.source.runs.length)return!1;var b=a.source.runs[a.source.runs.length-1];return"complete"!=b.status?!1:-1!=b.operation.indexOf("to database")},a["continue"]=function(){a.wizard?d.path("/datasets/"+g.name+"/model/measures"):f.setMessage("Yeah this doesn't do anything.","success"),a.resetScroll()},a.back=function(){d.path("/datasets/"+g.name+"/edit")},a.upload=function(){d.search(angular.extend({},d.search(),{next:"sources"})),d.path("/datasets/"+g.name+"/upload")};var j=function(b){var d=g.api_url+"/runs/"+b.id;c.get(d).then(function(b){b.data.messages.reverse(),
a.errors=b.data})};a.recheck=function(){c.get(h).then(function(b){var d=b.data;if(d.results.length){var f=d.results[0].runs_url;c.get(f).then(function(b){d.results.length||(i=e(a.recheck,2e3)),d.results[0].runs=b.data.results,a.source=d.results[0];var c=b.data.results[b.data.results.length-1];"failed"==c.status?j(c):i=e(a.recheck,2e3)})}else a.source={},i=e(a.recheck,2e3)})},a.recheck(),a.$on("$destroy",function(){e.cancel(i)})}]),spendb.controller("DatasetUploadCtrl",["$scope","$document","$http","$location","Upload","config","flash","validation","dataset",function(a,b,c,d,e,f,g,h,i){a.dataset=i,a.urlForm={},a.uploadPercent=null,a.file={};var j=function(){var b=a.wizard?"edit":"sources",c=d.search().next||b;d.path("/datasets/"+i.name+"/"+c)};a.setFile=function(b){for(var c in b)a.file=b[c]},a.uploadServer=function(){e.upload({url:i.api_url+"/sources/upload",file:a.file}).progress(function(b){a.uploadPercent=Math.max(1,parseInt(95*b.loaded/b.total))}).success(function(a,b,c,d){j()}).error(function(b,c,d,e){a.uploads=[],a.uploadPercent=null,g.setMessage("There was an error uploading your file. Please try again.","danger")})},a.uploadBucket=function(b){e.upload({url:b.url,method:"POST",fields:{key:b.key,AWSAccessKeyId:b.aws_key_id,acl:b.acl,policy:b.policy,signature:b.signature},file:a.file}).progress(function(b){a.uploadPercent=Math.max(1,parseInt(95*b.loaded/b.total))}).success(function(a,d,e,f){c.post(i.api_url+"/sources/load/"+b.source_name).then(function(){j()})}).error(function(b,c,d,e){a.uploads=[],a.uploadPercent=null,g.setMessage("There was an error uploading your file. Please try again.","danger")})},a.uploadFile=function(){if(a.hasFile()){a.uploadPercent=1;var b={file_name:a.file.name,mime_type:a.file.type};c.post(i.api_url+"/sources/sign",b).then(function(b){"ok"==b.data.status?a.uploadBucket(b.data):a.uploadServer()})}},a.submitUrl=function(){if(a.hasUrl()){var b=angular.copy(a.urlForm);a.urlForm={},c.post(i.api_url+"/sources/submit",b).then(function(a){j()})}},a.hasUrl=function(){return a.urlForm.url&&a.urlForm.url.length>3},a.hasFile=function(){return!a.uploadPercent&&a.file&&a.file.name},a["continue"]=function(){a.hasUrl()?a.submitUrl():a.uploadFile()},a.canContinue=function(){return a.hasUrl()||a.hasFile()}}]),spendb.directive("datasetList",["$http","$location",function(a,b){return{restrict:"AE",scope:{datasets:"="},templateUrl:"directives/dataset_list.html",link:function(a,c,d,e){a.load=function(a){var c=angular.extend({},b.search(),{offset:a});b.search(c)},a.getDatasetLink=function(a){var b="/datasets/"+a.name;return a.has_model||(b+="/about"),b}}}}]),spendb.directive("datasetSettings",["$rootScope","$http","$location",function(a,b,c){return{restrict:"AE",transclude:!0,scope:{dataset:"=",step:"@",nextLabel:"@",prevLabel:"@",prevActive:"=",prevHidden:"=",nextActive:"&",next:"&",prev:"&"},templateUrl:"directives/dataset_settings.html",link:function(b,d,e,f){var g=b.dataset?b.dataset.label:"Create a new dataset",h=c.search().mode,i="wizard"==h||!b.dataset||!b.dataset.api_url;a.setTitle(g),b._step=parseInt(b.step,10),b._nextLabel=b.nextLabel||"Next",b._prevLabel=b.prevLabel||"Back",b.prevShow=b.prevHidden?!1:i,b.wizard=b.$parent.wizard=i,b.navDataset=i?null:b.dataset,console.log(b.wizard?"Wizard mode":"Edit mode")}}}]),spendb.directive("pageBody",["$http","$location",function(a,b){return{restrict:"E",transclude:!0,templateUrl:"directives/page_body.html",link:function(a,b,c,d){}}}]),spendb.directive("pageHeader",["$http","$rootScope","$route","$location","$modal","flash","config","session",function(a,b,c,d,e,f,g,h){return{restrict:"E",scope:{dataset:"=",section:"@"},templateUrl:"directives/page_header.html",link:function(g,i,j,k){g.session={},g.flash=f,g.home_page="home.html"==c.current.loadedTemplateUrl,g.title=g.dataset?g.dataset.label:b.currentTitle,h.get(function(a){g.session=a}),g.logout=function(){h.logout(function(a){g.session=a,d.path("/")})},g.deleteDataset=function(){e.open({templateUrl:"dataset/delete.html",controller:"DatasetDeleteCtrl",backdrop:!0,resolve:{dataset:function(){return g.dataset}}})},g.togglePrivate=function(){g.dataset["private"]=!g.dataset["private"],a.post(g.dataset.api_url,g.dataset).then(function(a){a.data["private"]?f.setMessage("The dataset has been made private.","danger"):f.setMessage("The dataset is now public!","success")})}}}}]),spendb.directive("responsePager",["$timeout",function(a){return{restrict:"E",scope:{response:"=",load:"&load"},templateUrl:"directives/response_pager.html",link:function(a,b,c,d){a.$watch("response",function(b){if(a.showPager=!1,a.pages=[],!(a.response.pages<=1)){var c=[],d=a.response.offset/a.response.limit+1,e=Math.ceil(a.response.total/a.response.limit),f=3,g=d-f,h=d+f;1>g&&(g=1,h=Math.min(2*f+1,e)),h>e&&(h=e,g=Math.max(1,e-2*f+1));for(var i=g;h>=i;i++){var j=(i-1)*a.response.limit;c.push({page:i,current:i==d,offset:j})}a.showPager=!0,a.pages=c}})}}}]),ngBabbage.filter("formatDate",function(){var a=d3.time.format("%d.%m.%Y");return function(b){var c=new Date(Date.parse(b));return a(c)}});var loadIndex=["$q","$route","$http","config",function(a,b,c,d){var e=a.defer();return c.get(d.apiBaseUrl+"/api/3/pages/index.html").then(function(a){e.resolve(a.data)}),e.promise}],loadIndexDatasets=["$q","$http","$location","$route","config",function(a,b,c,d,e){var f=a.defer();return b.get(e.apiBaseUrl+"/api/3/datasets",{params:c.search()}).then(function(a){f.resolve(a.data)}),f.promise}];spendb.controller("HomeCtrl",["$scope","$rootScope","$location","$sce","page","config","datasets","session",function(a,b,c,d,e,f,g,h){a.setTitle(f.site_title),a.page=e,a.session=h,a.datasets=g,a.page_html=d.trustAsHtml(""+e.html),a.hasFacet=function(a,b){var d=c.search();return angular.isArray(d[a])?-1!=d[a].indexOf(b):d[a]==b},a.scrollToDatasets=function(){a.scrollToId("datasets")},a.toggleFacet=function(b,d){var e=c.search(),f=angular.isArray(e[b]);a.hasFacet(b,d)?f?e[b].splice(e[b].indexOf(d),1):delete e[b]:f?e[b].push(d):e[b]?e[b]=[e[b],d]:e[b]=d,e.offset&&delete e.offset,c.search(e)}}]);var loadSession=["$q","session",function(a,b){var c=a.defer();return b.get(function(a){c.resolve(a)}),c.promise}],loadDataset=["$route","$http","$q","config",function(a,b,c,d){var e=c.defer(),f=d.apiBaseUrl+"/api/3/datasets/"+a.current.params.dataset,g=d.apiBaseUrl+"/api/3/sessions/authz",h={dataset:a.current.params.dataset};return c.all([b.get(f),b.get(g,{params:h})]).then(function(a){var b=a[0].data,c=a[1].data;b.can_read=c.read,b.can_update=c.update,e.resolve(b)}),e.promise}],loadManagers=["$route","$http","$q","config",function(a,b,c,d){var e=c.defer(),f=d.apiBaseUrl+"/api/3/datasets/"+a.current.params.dataset+"/managers";return b.get(f).then(function(a){e.resolve(a.data)}),e.promise}],loadSources=["$route","$http","$q","config",function(a,b,c,d){var e=c.defer(),f=d.apiBaseUrl+"/api/3/datasets/"+a.current.params.dataset+"/sources";return b.get(f).then(function(a){e.resolve(a.data)}),e.promise}],loadReferenceData=["$q","data",function(a,b){var c=a.defer();return b.get(function(a){c.resolve(a)}),c.promise}],loadModel=["$route","$q","$http","config",function(a,b,c,d){var e=d.apiBaseUrl+"/api/3/datasets/"+a.current.params.dataset,f=b.defer();return b.all([c.get(e+"/structure"),c.get(e+"/model")]).then(function(a){f.resolve({structure:a[0].data,model:a[1].data})}),f.promise}];spendb.factory("flash",["$rootScope","$timeout",function(a,b){var c=null;return{setMessage:function(a,d){c=[a,d],b(function(){c=null},4e3)},getMessage:function(){return c?c[0]:void 0},getType:function(){return c?c[1]:void 0}}}]),spendb.factory("validation",["flash","config",function(a,b){return{handle:function(b){return function(c){if(400!=c.status&&b)a.setMessage(c.data.message||c.data.title||"Server error","danger");else{var d=[];for(var e in c.data.errors)b[e].$setValidity("value",!1),b[e].$message=c.data.errors[e],d.push(e);angular.isDefined(b._errors)&&angular.forEach(b._errors,function(a){-1==d.indexOf(a)&&b[a].$setValidity("value",!0)}),b._errors=d}}},clear:function(a){if(angular.isDefined(a._errors))for(var b in a._errors){var c=a._errors[b];a[c].$setValidity("value",!0),a[c].$message=void 0}a._errors=void 0,a.$setPristine(),a.$setValidity()}}}]),spendb.factory("data",["$http","config",function(a,b){var c=a.get(b.apiBaseUrl+"/api/3/reference"),d=function(a){c.then(function(b){a(b.data)})};return{get:d}}]),spendb.factory("session",["$http","config",function(a,b){var c=null,d=function(d){a.post(b.apiBaseUrl+"/api/3/sessions/logout").then(function(){c=null,f(d)})},e=function(){c=null},f=function(d){if(null===c){var e={_:new Date};c=a.get(b.apiBaseUrl+"/api/3/sessions",{params:e})}c.then(function(a){d(a.data)})};return{get:f,flush:e,logout:d}}]);